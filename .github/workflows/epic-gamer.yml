name: Epic Awesome Gamer (Scheduled)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    # æ¯å¤© UTC 08:00 (åŒ—äº¬æ—¶é—´ 16:00) è¿è¡Œä¸€æ¬¡
    - cron: '0 8 * * *'

jobs:
  epic-gamer:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    # ğŸ”´ [æ ¸å¿ƒä¿®æ”¹] åªæœ‰å½“ä»“åº“ä¸æ˜¯ '10000ge10000/epic-awesome-gamer' æ—¶æ‰è¿è¡Œ
    # æ•ˆæœï¼šä½ çš„ä»“åº“è§¦å‘å®šæ—¶ä»»åŠ¡ä¼šç›´æ¥æ˜¾ç¤º Skipped (ç°è‰²)ï¼Œåˆ«äºº Fork åä¼šæ­£å¸¸è¿è¡Œ (ç»¿è‰²)
    if: github.repository != '10000ge10000/epic-awesome-gamer'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb libxml2-dev libxslt-dev

      - name: Install dependencies
        run: uv sync

      # å¢åŠ  GITHUB_TOKEN ä»¥è§£å†³ Camoufox ä¸‹è½½æ—¶çš„ 403 é¢‘ç‡é™åˆ¶
      - name: Install Camoufox
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: uv run camoufox fetch

      - name: Run Epic Awesome Gamer
        env:
          EPIC_EMAIL: ${{ secrets.EPIC_EMAIL }}
          EPIC_PASSWORD: ${{ secrets.EPIC_PASSWORD }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ secrets.GEMINI_MODEL }}

          # LLM è°ƒç”¨å±‚ï¼ˆæ¨èç”¨æ–°å˜é‡ï¼›å…¼å®¹æ—§å˜é‡é¿å…ç©ºå€¼è¦†ç›–ï¼‰
          LLM_MODE: ${{ secrets.LLM_MODE || 'gemini_native' }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL || secrets.GEMINI_BASE_URL || 'https://generativelanguage.googleapis.com' }}
          GEMINI_BASE_URL: ${{ secrets.LLM_BASE_URL || secrets.GEMINI_BASE_URL || 'https://generativelanguage.googleapis.com' }}

          # å…³é”®ï¼šè®©éªŒè¯ç æ±‚è§£çœŸæ­£ä½¿ç”¨ä½ å¡«å†™çš„æ¨¡å‹ï¼ˆé»˜è®¤å…¨éƒ¨è·Ÿéš GEMINI_MODELï¼‰
          CHALLENGE_CLASSIFIER_MODEL: ${{ secrets.GEMINI_MODEL }}
          IMAGE_CLASSIFIER_MODEL: ${{ secrets.GEMINI_MODEL }}
          SPATIAL_POINT_REASONER_MODEL: ${{ secrets.GEMINI_MODEL }}
          SPATIAL_PATH_REASONER_MODEL: ${{ secrets.GEMINI_MODEL }}
          # åœ¨ Actions ä¸­æˆ‘ä»¬ä¾é  GitHub çš„ cron è§¦å‘ï¼Œæ‰€ä»¥å…³é—­å†…éƒ¨è°ƒåº¦å™¨
          ENABLE_APSCHEDULER: false
          PYTHONPATH: app
        run: |
          echo "ğŸš€ å¯åŠ¨å®šæ—¶é¢†å–ä»»åŠ¡..."
          xvfb-run --auto-servernum --server-num=1 --server-args='-screen 0, 1920x1080x24' uv run app/deploy.py
